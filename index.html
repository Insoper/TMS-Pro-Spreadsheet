<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#007bff">
  <title>TMS Pro</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Common styles */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      margin: 0;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    .judul-besar {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0 20px;
    }
    
    h2, h3, label {
      font-size: 16px;
      font-weight: bold;
      margin: 8px 0 5px;
    }
    
    select {
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 6px;
      width: 100%;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      background-color: white;
    }
    
    button {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #888;
      margin: 4px 0;
      width: 100%;
      min-height: 44px; /* Better touch target */
    }
    
    .button-group {
      margin: 4px 0;
    }
    
    .button-group button {
      background-color: #007bff;
      color: white;
      border: none;
      min-width: auto;
    }
    
    .button-group button.active {
      background-color: #003f7f;
    }
    
    .button-group button:disabled {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    
    .grid-2col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .hasil, .resume {
      background: #f9f9f9;
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 8px;
      min-width: 500px;
    }
    
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    
    .charts {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }
    
    .charts canvas {
      width: 100% !important;
      height: auto !important;
    }
    
    .fill-factor-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    
    .fill-factor-grid button {
      background-color: #e0f0ff;
      color: #004b7f;
      border: 1px solid #007bff;
      font-weight: bold;
      border-radius: 8px;
      padding: 10px 0;
      transition: background-color 0.2s ease;
      min-height: 50px;
    }
    
    .fill-factor-grid button.active {
      background-color: #007bff;
      color: white;
    }
    
    .fill-factor-grid button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Login styles */
    #loginContainer {
      width: 100%;
      max-width: 100%;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }
    
    .login-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    .login-logo {
      width: 100px;
      height: auto;
      object-fit: contain;
    }
    
    .login-form {
      width: 100%;
    }
    
    .login-form input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      min-height: 44px;
    }
    
    .login-form button {
      width: 100%;
      padding: 12px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    /* Step timer */
    #stepTimer {
      display: none;
      font-weight: bold;
      font-size: 16px;
      padding: 8px 12px;
      border: 2px solid #007bff;
      border-radius: 8px;
      background-color: #f0f8ff;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin: 10px 0;
    }
    
    /* View navigation */
    .view-container {
      display: none;
      width: 100%;
      max-width: 100%;
      padding: 0 5px;
    }
    
    .nav-button {
      margin: 10px 0;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    
    /* iOS install prompt */
    #iosInstallPrompt {
      display: none;
      padding: 12px;
      background: #fef7d1;
      border: 1px solid #e6c200;
      font-size: 14px;
      margin-top: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    /* Truck counter */
    #truckCounterContainer {
      display: block;
      margin: 10px 0;
    }
    
    #truckCounterContainer button {
      display: inline-block;
      width: 50px;
      margin: 0 5px;
    }
    
    #truckCount {
      display: inline-block;
      min-width: 30px;
      text-align: center;
      font-weight: bold;
    }
    
    /* Button container for operation view */
    .button-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .button-row button {
      flex: 1;
    }
    
    /* Responsive adjustments */
    @media (min-width: 768px) {
      body {
        padding: 15px;
        max-width: 960px;
        margin: 0 auto;
      }
      
      .judul-besar {
        font-size: 36px;
      }
      
      .charts {
        flex-direction: row;
      }
      
      .charts canvas {
        width: 48% !important;
      }
      
      #loginContainer {
        max-width: 700px;
        margin: 50px auto;
        padding: 30px;
      }
      
      .login-content {
        flex-direction: row;
        align-items: center;
        gap: 30px;
      }
      
      .login-logo {
        width: 120px;
      }
    }
  </style>
</head>
<body onload="initializeForm()">

<!-- View 1: Login -->
<div id="loginView" class="view-container">
  <div id="loginContainer">
    <div class="login-content">
      <div class="logo-container">
        <img src="logo.png" alt="Logo" class="login-logo" />
      </div>
      <div class="login-form">
        <h2>Login</h2>
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" />
        </div>
        <div class="form-group" style="position: relative;">
          <label for="password">Password:</label>
          <input type="password" id="password" style="padding-right: 40px;" />
          <span onclick="togglePassword()" style="position: absolute; right: 10px; bottom: 8px; cursor: pointer; font-size: 18px;">üëÅÔ∏è</span>
        </div>
        <button onclick="checkLogin()">Login</button>
        <p id="loginError" style="color: red;"></p>
      </div>
    </div>
  </div>
</div>

<!-- View 2: Input Alat -->
<div id="inputAlatView" class="view-container">
  <h1 class="judul-besar">TMS Pro</h1>
  
  <label>Type Alat:</label>
  <select id="typeAlat">
    <option value="">-- Pilih Type Alat --</option>
    <option value="PC1250-8">PC1250-8</option>
    <option value="PC1250-11R">PC1250-11R</option>
    <option value="PC2000-8">PC2000-8</option>
    <option value="PC2000-11R">PC2000-11R</option>
    <option value="PC3400-11M0">PC3400-11M0</option>
  </select>

  <label>Kapasitas Bucket (m¬≥):</label>
  <select id="kapasitasBucket">
    <option value="">-- Pilih Kapasitas --</option>
  </select>

  <label>Metode Loading:</label>
  <select id="metodeLoading">
    <option value="">-- Pilih Metode --</option>
    <option>Top Loading</option>
    <option>Bench Loading</option>
    <option>Double Bench Loading</option>
  </select>

  <label>Jenis Material:</label>
  <select id="jenisMaterial">
    <option value="">-- Pilih Material --</option>
    <option value="0.9">Sand</option>
    <option value="0.8">Sandy Clay</option>
    <option value="0.7">Clay</option>
    <option value="0.85">Gravelly Soil</option>
    <option value="0.88">Gravel</option>
    <option value="0.7">Solid or Rugged Gravel</option>
    <option value="0.61">Limestone/Sandstone/Soft Rocks</option>
    <option value="0.59">Granite/Basalt/Hard Rocks</option>
    <option value="0.57">Rocks</option>
  </select>
  
  <button id="btnNextToOperation" class="nav-button" onclick="showOperationView()" disabled>Lanjut ke Operasi ‚Üí</button>
</div>

<!-- View 3: Operation -->
<div id="operationView" class="view-container">
  <h1 class="judul-besar">TMS Pro</h1>
  
  <div class="button-row">
    <button id="btnStart" onclick="startSession()" disabled>‚ñ∂Ô∏è Mulai</button>
    <button id="btnPause" onclick="togglePause()" disabled>‚è∏Ô∏è Pause</button>
    <button id="btnEdit" onclick="startEdit()" disabled>‚úèÔ∏è Edit</button>
  </div>

  <div id="truckCounterContainer">
    <label><strong>Truck Counter:</strong></label><br>
    <button onclick="updateTruckCount(-1)" id="btnMinus" disabled>-</button>
    <span id="truckCount">0</span>
    <button onclick="updateTruckCount(1)" id="btnPlus" disabled>+</button>
  </div>

  <div id="stepTimer">
    ‚è±Ô∏è <span id="stepTimerValue">0.0</span> detik
  </div>

  <h3>Bucket Fill Factor:</h3>
  <div class="fill-factor-grid" id="fillFactors">
    <button onclick="setFill(this, 0.7)" disabled>0.7</button>
    <button onclick="setFill(this, 0.8)" disabled>0.8</button>
    <button onclick="setFill(this, 0.9)" disabled>0.9</button>
    <button onclick="setFill(this, 1.0)" class="active" disabled>1.0</button>
    <button onclick="setFill(this, 1.1)" disabled>1.1</button>
    <button onclick="setFill(this, 1.2)" disabled>1.2</button>
  </div>

  <h3>Primary Work:</h3>
  <div class="button-group grid-2col" id="primaryButtons">
    <button onclick="addStep(this, 'Primary Work', 'Dig to Load')" disabled>Dig to Load ‚Üí</button>
    <button onclick="addStep(this, 'Primary Work', 'Swing Loaded')" disabled>Swing Loaded ‚Üì</button>
    <button onclick="addStep(this, 'Primary Work', 'Swing Empty')" disabled>Swing Empty ‚Üë</button>
    <button onclick="addStep(this, 'Primary Work', 'Dump')" disabled>Dump ‚Üê</button>
  </div>

  <h3>Secondary Work:</h3>
  <div class="button-group grid-2col" id="secondaryButtons">
    <button onclick="addStep(this, 'Secondary Work', 'Dig to Prepare')" disabled>Dig to Prepare</button>
    <button onclick="addStep(this, 'Secondary Work', 'Wait to Dump')" disabled>Wait to Dump</button>
    <button onclick="addStep(this, 'Secondary Work', 'Idle')" disabled>Idle</button>
    <button onclick="addStep(this, 'Secondary Work', 'Cleaning')" disabled>Cleaning</button>
    <button onclick="addStep(this, 'Secondary Work', 'Positioning')" disabled>Positioning</button>
    <button onclick="addStep(this, 'Secondary Work', 'Others')" disabled>Others</button>
  </div>

  <button id="btnSelesai" onclick="selesaiSession()" disabled>‚úÖ Selesai</button>
  <button id="btnSummary" onclick="hitungProduksi()" disabled>üìä Summary</button>
  <button id="btnExportPDF" onclick="exportPDF()" disabled>üßæ Export ke PDF</button>
  <button id="btnExportExcel" onclick="exportExcel()" disabled>üìÑ Export ke Excel</button>
  <button id="btnExportSheets" onclick="exportToGoogleSheets()" disabled>üì§ Export ke Google Sheets</button>
  <button id="btnKembaliInput" class="nav-button" onclick="kembaliKeInputAwal()" disabled>Kembali ke Input Awal</button>

  <div class="hasil" id="output"></div>
  <div class="resume" id="resume"></div>
  <div class="charts">
    <canvas id="pieChart"></canvas>
    <canvas id="barChart"></canvas>
  </div>
</div>

<!-- iOS install prompt -->
<div id="iosInstallPrompt">
  üì± Untuk menginstal aplikasi ini di iPhone, tap tombol <strong>Bagikan</strong> (ikon ‚¨ÜÔ∏è di bawah), lalu pilih <strong>Tambahkan ke Layar Utama</strong>.
</div>

<script>
// View management functions
function showLoginView() {
  document.getElementById('loginView').style.display = 'block';
  document.getElementById('inputAlatView').style.display = 'none';
  document.getElementById('operationView').style.display = 'none';
  appState.currentView = 'login';
  
  // Save session data
  saveSessionData();
}

/**
 * Shows the equipment input view and hides other views
 */
function showInputAlatView() {
  // Hide all views first
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('operationView').style.display = 'none';
  
  // Show input view
  document.getElementById('inputAlatView').style.display = 'block';
  
  // Update form button state
  cekForm();
  
  // Update app state
  appState.currentView = 'input';
  
  // Save session data
  saveSessionData();
  
  // Trigger bucket options update based on selected equipment
  const event = new Event('change');
  elements.typeAlat.dispatchEvent(event);
}

/**
 * Shows the operation view and hides other views
 */
function showOperationView() {
  // Hide all views first
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('inputAlatView').style.display = 'none';
  
  // Show operation view
  document.getElementById('operationView').style.display = 'block';
  
  // Update app state
  appState.currentView = 'operation';
  
  // Initialize operation view components
  initializeOperationView();
  
  // Save session data
  saveSessionData();
}

// Application variables
let logs = [], currentFill = 1.0, started = false, lastTime = null, lastLabel = null;
let stepTimerInterval = null;
let stepStartTime = null;
let truckCount = 0;
let paused = false;
let correctionIndex = 0;
let stepElapsedTime = 0;
let pauseStartTime = null;
let totalPausedTime = 0;
let editing = false;

  // Deklarasi elements di awal
const elements = {
  typeAlat: document.getElementById('typeAlat'),
  kapasitasBucket: document.getElementById('kapasitasBucket'),
  metodeLoading: document.getElementById('metodeLoading'),
  jenisMaterial: document.getElementById('jenisMaterial')

// Save session data to localStorage
function saveSessionData() {
  const sessionData = {
    // Form data
    typeAlat: document.getElementById("typeAlat").value,
    kapasitasBucket: document.getElementById("kapasitasBucket").value,
    metodeLoading: document.getElementById("metodeLoading").value,
    jenisMaterial: document.getElementById("jenisMaterial").value,
    
    // Session state
    sessionActive: started,
    currentView: started ? 'operation' : 
                document.getElementById('inputAlatView').style.display === 'block' ? 'input' : 'login',
    
    // Operation data
    logs: logs,
    currentFill: currentFill,
    started: started,
    lastTime: lastTime,
    lastLabel: lastLabel,
    truckCount: truckCount,
    correctionIndex: correctionIndex,
    
    // Timer state
    stepElapsedTime: stepElapsedTime,
    pauseStartTime: pauseStartTime,
    totalPausedTime: totalPausedTime,
    
    // UI state
    editing: editing,
    paused: paused,
    
    // Additional metadata
    lastSaved: new Date().toISOString(),
    version: 1.2
  };
  
  try {
    localStorage.setItem("tmsSessionData", JSON.stringify(sessionData));
  } catch (e) {
    console.error("Error saving session data:", e);
    // Handle storage full error if needed
    if (e.name === 'QuotaExceededError') {
      alert("Penyimpanan lokal penuh. Data sesi tidak dapat disimpan.");
    }
  }
}

// Initialize the app
function initializeForm() {
  // 1. First, check for existing session data
  const sessionData = localStorage.getItem("tmsSessionData");
  
  // 2. If session data exists, try to restore it
  if (sessionData) {
    try {
      const data = JSON.parse(sessionData);
      
      // 3. Restore all form selections
      if (data.typeAlat) document.getElementById("typeAlat").value = data.typeAlat;
      if (data.kapasitasBucket) document.getElementById("kapasitasBucket").value = data.kapasitasBucket;
      if (data.metodeLoading) document.getElementById("metodeLoading").value = data.metodeLoading;
      if (data.jenisMaterial) document.getElementById("jenisMaterial").value = data.jenisMaterial;
      
      // 4. Determine which view to show based on saved state
      if (data.sessionActive || data.currentView === 'operation') {
        // Case 1: Was in operation view (either active session or just viewing results)
        showOperationView();
        
        // Restore all operation variables
        logs = data.logs || [];
        currentFill = data.currentFill || 1.0;
        started = data.started || false;
        lastTime = data.lastTime || null;
        lastLabel = data.lastLabel || null;
        truckCount = data.truckCount || 0;
        correctionIndex = data.correctionIndex || 0;
        stepElapsedTime = data.stepElapsedTime || 0;
        pauseStartTime = data.pauseStartTime || null;
        totalPausedTime = data.totalPausedTime || 0;
        editing = data.editing || false;
        paused = data.paused || false;

        // Update UI elements
        document.getElementById('truckCount').innerText = truckCount;
        
        // If session was active, restore the working state
        if (started) {
          document.getElementById('btnStart').disabled = true;
          document.getElementById('btnPause').disabled = false;
          document.getElementById('btnEdit').disabled = !paused;
          document.getElementById('btnSelesai').disabled = paused ? false : true;
          document.getElementById('btnKembaliInput').disabled = true;
          
          document.getElementById('truckCounterContainer').style.display = 'block';
          document.getElementById('btnPlus').disabled = false;
          document.getElementById('btnMinus').disabled = false;
          
          // Restore fill factor buttons state
          document.querySelectorAll('#fillFactors button').forEach(btn => {
            btn.disabled = !(lastLabel && (lastLabel.item === "Dig to Load" || lastLabel.item === "Swing Loaded"));
            btn.classList.toggle('active', parseFloat(btn.textContent) === currentFill);
          });
          
          // Restore work buttons state
          document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(btn => {
            btn.disabled = paused;
            btn.classList.toggle('active', lastLabel && btn.textContent.includes(lastLabel.item));
          });
          
          // Handle timer restoration
          if (lastTime && !paused) {
            resetStepTimer(); // Restart the timer if was running
          } else if (stepElapsedTime > 0) {
            // Show elapsed time if paused
            document.getElementById('stepTimer').style.display = 'block';
            document.getElementById('stepTimerValue').innerText = stepElapsedTime.toFixed(1);
          }
          
          // Update pause button text
          document.getElementById("btnPause").innerText = paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
        }
        
        // Skip showing login view since we're restoring operation view
        return;
      }
      else if (data.currentView === 'input') {
        // Case 2: Was in input alat view
        showInputAlatView();
        return;
      }
    } catch (e) {
      console.error("Error parsing session data", e);
      // If corrupted, clear the bad data
      localStorage.removeItem("tmsSessionData");
    }
  }

  // 5. Default case: Show login view if no valid session
  showLoginView();
  
  // 6. Check for saved login credentials
  const savedLogin = localStorage.getItem("loginUser");
  if (savedLogin) {
    try {
      const { user, pass, time } = JSON.parse(savedLogin);
      const now = Date.now();
      const diffHours = (now - time) / (1000 * 60 * 60);

      // Only auto-fill if within 24 hours
      if (diffHours <= 24) {
        document.getElementById("username").value = user;
        document.getElementById("password").value = pass;
      } else {
        localStorage.removeItem("loginUser");
      }
    } catch (e) {
      console.error("Error parsing saved login", e);
    }
  }

  // 7. iOS install prompt
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase());
  const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;
  if (isIOS && !isInStandaloneMode) {
    document.getElementById('iosInstallPrompt').style.display = 'block';
  }

  // 8. Setup event listeners for form elements
  elements.typeAlat.addEventListener("change", function() {
    const type = this.value;
    elements.kapasitasBucket.innerHTML = '<option value="">-- Pilih Kapasitas --</option>';

    // Set bucket options based on equipment type
    let options = [];
    if (type === "PC1250-8" || type === "PC1250-11R") {
      options = [6.7, 7.5];
    } else if (type === "PC2000-8" || type === "PC2000-11R") {
      options = [12, 14];
    } else if (type === "PC3400-11M0") {
      options = [18, 19.7];
    }

    if (options.length > 0) {
      options.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val.toString();
        elements.kapasitasBucket.appendChild(opt);
      });
    } else {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "-- Isi Manual --";
      elements.kapasitasBucket.appendChild(opt);
    }
    
    cekForm();
    saveSessionData();
  });

  // Setup other dropdown listeners
  ['kapasitasBucket', 'metodeLoading', 'jenisMaterial'].forEach(id => {
    document.getElementById(id).addEventListener('change', function() {
      cekForm();
      saveSessionData();
    });
  });

  // Initial form check
  cekForm();
}

function cekForm() {
  const filled = document.getElementById('typeAlat').value &&
               document.getElementById('kapasitasBucket').value &&
               document.getElementById('metodeLoading').value &&
               document.getElementById('jenisMaterial').value;
  document.getElementById('btnStart').disabled = !filled;
  document.getElementById('btnNextToOperation').disabled = !filled;
}

  /**
 * Checks if form is complete
 */
function isFormComplete() {
  return elements.typeAlat.value &&
         elements.kapasitasBucket.value &&
         elements.metodeLoading.value &&
         elements.jenisMaterial.value;
}

function checkLogin() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  
  if (user === 'Insoper_UT' && pass === 'dediKASI') {
    const now = new Date().getTime();
    localStorage.setItem("loginUser", JSON.stringify({ user, pass, time: now }));
    showInputAlatView();
  } else {
    document.getElementById('loginError').innerText = 'Username atau password salah';
  }
}

function togglePassword() {
  const input = document.getElementById("password");
  input.type = input.type === "password" ? "text" : "password";
}

function setFill(btn, val) {
  if (!started) return;
  currentFill = val;
  document.querySelectorAll('#fillFactors button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  saveSessionData();
}

function startSession() {
  // Initialize session variables
  started = true;
  logs = [];
  currentFill = 1.0;
  lastTime = null;
  lastLabel = null;
  truckCount = 0;
  correctionIndex = 0;
  stepElapsedTime = 0;
  pauseStartTime = null;
  totalPausedTime = 0;
  editing = false;
  paused = false;

  // Update UI elements
  document.getElementById('truckCount').textContent = '0';
  document.getElementById('stepTimerValue').textContent = '0.0';
  document.getElementById('output').innerHTML = '';
  document.getElementById('resume').innerHTML = '';

  // Set button states
  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnPause').disabled = false;
  document.getElementById('btnEdit').disabled = true;
  document.getElementById('btnSelesai').disabled = true;
  document.getElementById('btnKembaliInput').disabled = true;
  document.getElementById('btnSummary').disabled = true;
  document.getElementById('btnExportPDF').disabled = true;
  document.getElementById('btnExportExcel').disabled = true;
  document.getElementById('btnExportSheets').disabled = true;

  // Enable truck counter
  document.getElementById('truckCounterContainer').style.display = 'block';
  document.getElementById('btnPlus').disabled = false;
  document.getElementById('btnMinus').disabled = false;

  // Enable operation buttons
  document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(btn => {
    btn.disabled = false;
    btn.classList.remove('active');
  });

  // Set default fill factor
  document.querySelectorAll('#fillFactors button').forEach(btn => {
    btn.disabled = true; // Initially disabled until Dig/Swing
    if (btn.textContent === '1.0') {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Reset charts if any
  const pieChart = document.getElementById('pieChart').chart;
  const barChart = document.getElementById('barChart').chart;
  if (pieChart) pieChart.destroy();
  if (barChart) barChart.destroy();

  // Show timer
  document.getElementById('stepTimer').style.display = 'block';

  // Change start button to reset function
  const startBtn = document.getElementById('btnStart');
  startBtn.textContent = 'üîÑ Reset';
  startBtn.onclick = resetSession;

  // Save session
  saveSessionData();

  // Log start event
  console.log('New measurement session started at', new Date().toLocaleTimeString());
}

function addStep(btn, category, item) {
  if (!started) return;

  document.getElementById("btnPause").disabled = false;

  if (editing) {
    lastLabel = { category, item };
    editing = false;

    // Nonaktifkan lagi tombol pilihan
    document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.disabled = true);

    alert(`Langkah telah diperbaiki menjadi: ${item}`);
    saveSessionData();
    return;
  }

  const now = Date.now();

  if (lastTime !== null) {
    // Pastikan totalPausedTime sudah terupdate jika sedang pause sebelumnya
    if (paused && pauseStartTime) {
      totalPausedTime += (now - pauseStartTime);
      pauseStartTime = null;
    }

    // Hitung durasi AKTIF saja (tidak termasuk waktu pause)
    const durasiAktif = ((now - lastTime) - totalPausedTime) / 1000;

    logs.push({
      category: lastLabel.category,
      item: lastLabel.item,
      durasi: durasiAktif,
      fillFactor: currentFill
    });
  }

  // Siapkan langkah baru
  lastTime = now;
  lastLabel = { category, item };

  // Reset untuk langkah berikutnya
  stepElapsedTime = 0;
  pauseStartTime = null;
  totalPausedTime = 0;

  resetStepTimer();

  // Reset tampilan tombol
  document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const fillButtons = document.querySelectorAll('#fillFactors button');
  if (item === 'Dig to Load' || item === 'Swing Loaded') {
    fillButtons.forEach(b => b.disabled = false);
  } else {
    fillButtons.forEach(b => b.disabled = true);
  }
  
  saveSessionData();
}

function selesaiSession() {
  if (!started || lastTime === null || lastLabel === null) return;
  const now = Date.now();

  // Jika masih dalam kondisi pause, hitung totalPausedTime terakhir
  if (paused && pauseStartTime) {
    totalPausedTime += (now - pauseStartTime);
    pauseStartTime = null;
  }

  // Hitung durasi AKTIF saja (tidak termasuk waktu pause)
  const durasiAktif = ((now - lastTime) - totalPausedTime) / 1000;

  logs.push({
    category: lastLabel.category,
    item: lastLabel.item,
    durasi: durasiAktif,
    fillFactor: currentFill
  });

  started = false;
  lastTime = null;
  lastLabel = null;

  document.querySelectorAll('#operationView button').forEach(b => b.disabled = true);
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnSummary').disabled = false;
  document.getElementById('btnKembaliInput').disabled = false; // Enable the Kembali button

  // Nonaktifkan counter dan timer
  document.getElementById('btnPlus').disabled = true;
  document.getElementById('btnMinus').disabled = true;
  document.getElementById('truckCounterContainer').style.display = 'none';
  clearInterval(stepTimerInterval);
  document.getElementById('stepTimer').style.display = 'none';

  // Nonaktifkan tombol pause
  paused = false;
  document.getElementById("btnPause").disabled = true;
  document.getElementById("btnPause").innerText = "‚è∏Ô∏è Pause";

  const btnStart = document.getElementById('btnStart');
  btnStart.innerText = "üîÑ Reset";
  btnStart.onclick = resetSession;
  
  saveSessionData();
}

function resetSession() {
  // Reset variabel
  logs = [];
  currentFill = 1.0;
  started = false;
  lastTime = null;
  lastLabel = null;
  truckCount = 0;
  correctionIndex = 0;
  editing = false;

  stepElapsedTime = 0;
  pauseStartTime = null;
  totalPausedTime = 0;

  // Kosongkan tampilan
  document.getElementById('output').innerHTML = '';
  document.getElementById('resume').innerHTML = '';

  // Reset grafik
  const pieChartCanvas = document.getElementById("pieChart");
  const barChartCanvas = document.getElementById("barChart");
  if (pieChartCanvas && pieChartCanvas.chart) pieChartCanvas.chart.destroy();
  if (barChartCanvas && barChartCanvas.chart) barChartCanvas.chart.destroy();

  // Reset tombol mulai
  const btnStart = document.getElementById('btnStart');
  btnStart.innerText = "‚ñ∂Ô∏è Mulai";
  btnStart.onclick = startSession;
  btnStart.disabled = true;
  document.getElementById('btnKembaliInput').disabled = true;

  // Reset timer
  document.getElementById('stepTimerValue').innerText = "0.0";
  document.getElementById('stepTimer').style.display = "none";

  // Nonaktifkan export
  document.getElementById("btnExportPDF").disabled = true;
  document.getElementById("btnExportExcel").disabled = true;
  document.getElementById("btnExportSheets").disabled = true;

  // Nonaktifkan fill factor active
  document.querySelectorAll('#fillFactors button').forEach(btn => {
    btn.classList.remove('active');
    if (btn.innerText === "1.0") btn.classList.add('active');
  });

  // Cek form lagi
  cekForm();
  
  // Clear session data
  localStorage.removeItem("tmsSessionData");
}

function updateTruckCount(delta) {
  if (!started) return;
  truckCount += delta;
  if (truckCount < 0) truckCount = 0;
  document.getElementById('truckCount').innerText = truckCount;
  saveSessionData();
}

function resetStepTimer() {
  clearInterval(stepTimerInterval);
  stepStartTime = Date.now();
  document.getElementById('stepTimer').style.display = 'block';

  stepTimerInterval = setInterval(() => {
    const now = Date.now();
    const elapsed = ((now - stepStartTime) / 1000) + stepElapsedTime;
    document.getElementById('stepTimerValue').innerText = elapsed.toFixed(1);
  }, 100);
}

function togglePause() {
  // Only allow pausing if a work step has been selected
  if (!paused && (!lastLabel || !lastTime)) {
    alert("Silakan pilih langkah kerja terlebih dahulu sebelum pause");
    return;
  }

  // Toggle pause state
  paused = !paused;
  
  // Update button text
  document.getElementById("btnPause").innerText = paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
  
  // Enable/disable edit button
  document.getElementById("btnEdit").disabled = !paused;

  // Get all relevant buttons
  const primaryButtons = document.querySelectorAll('#primaryButtons button');
  const secondaryButtons = document.querySelectorAll('#secondaryButtons button');
  const fillFactorButtons = document.querySelectorAll('#fillFactors button');

  if (paused) {
    // When pausing:
    // Disable all work buttons
    primaryButtons.forEach(btn => btn.disabled = true);
    secondaryButtons.forEach(btn => btn.disabled = true);
    fillFactorButtons.forEach(btn => btn.disabled = true);
    
    // Enable finish button
    document.getElementById('btnSelesai').disabled = false;

    // Record pause start time
    pauseStartTime = Date.now();
    
    // Stop the timer
    clearInterval(stepTimerInterval);
    
    // Calculate elapsed time
    const now = Date.now();
    stepElapsedTime += (now - stepStartTime) / 1000;
    
    // Update timer display
    document.getElementById('stepTimer').style.display = 'block';
    document.getElementById('stepTimerValue').innerText = stepElapsedTime.toFixed(1);
  } else {
    // When resuming:
    // Calculate total paused time
    if (pauseStartTime) {
      totalPausedTime += (Date.now() - pauseStartTime);
      pauseStartTime = null;
    }

    if (started) {
      // Re-enable appropriate buttons
      primaryButtons.forEach(btn => btn.disabled = false);
      secondaryButtons.forEach(btn => btn.disabled = false);
      
      // Only enable fill factor buttons for specific steps
      if (lastLabel && (lastLabel.item === "Dig to Load" || lastLabel.item === "Swing Loaded")) {
        fillFactorButtons.forEach(btn => btn.disabled = false);
      }
    }
    
    // Restart the timer
    resetStepTimer();
    
    // Disable finish button during operation
    document.getElementById('btnSelesai').disabled = true;
  }
  
  saveSessionData();
}

function startEdit() {
  if (!paused || !lastLabel) return;

  editing = true;
  document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.disabled = false);
  alert("Silakan pilih langkah baru untuk mengganti langkah aktif sebelumnya.");
  saveSessionData();
}

function kembaliKeInputAwal() {
  // Clear session data
  localStorage.removeItem("tmsSessionData");
  
  // Reset all operation variables
  logs = [];
  currentFill = 1.0;
  started = false;
  lastTime = null;
  lastLabel = null;
  truckCount = 0;
  correctionIndex = 0;
  stepElapsedTime = 0;
  pauseStartTime = null;
  totalPausedTime = 0;
  editing = false;
  paused = false;
  
  // Reset UI
  document.getElementById('output').innerHTML = '';
  document.getElementById('resume').innerHTML = '';
  document.getElementById('truckCount').innerText = '0';
  document.getElementById('stepTimerValue').innerText = "0.0";
  document.getElementById('stepTimer').style.display = "none";
  
  // Reset charts
  const pieChartCanvas = document.getElementById("pieChart");
  const barChartCanvas = document.getElementById("barChart");
  if (pieChartCanvas && pieChartCanvas.chart) pieChartCanvas.chart.destroy();
  if (barChartCanvas && barChartCanvas.chart) barChartCanvas.chart.destroy();
  
  // Reset buttons
  document.getElementById('btnStart').innerText = "‚ñ∂Ô∏è Mulai";
  document.getElementById('btnStart').onclick = startSession;
  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnKembaliInput').disabled = true;
  
  // Reset fill factors
  document.querySelectorAll('#fillFactors button').forEach(btn => {
    btn.classList.remove('active');
    if (btn.innerText === "1.0") btn.classList.add('active');
  });
  
  // Show input alat view
  showInputAlatView();
  
  // Clear form selections
  document.getElementById("typeAlat").value = "";
  document.getElementById("kapasitasBucket").innerHTML = '<option value="">-- Pilih Kapasitas --</option>';
  document.getElementById("metodeLoading").value = "";
  document.getElementById("jenisMaterial").value = "";
}

function hitungProduksi() {
  if (logs.length === 0) {
    alert("Belum ada data aktivitas yang dicatat.");
    return;
  }
  
  const typeAlat = document.getElementById("typeAlat").value;
  const kapasitas = document.getElementById("kapasitasBucket").value;
  const metode = document.getElementById("metodeLoading").value;

  const bucket = parseFloat(kapasitas) || 1;
  const primary = logs.filter(l => l.category === 'Primary Work');
  const secondary = logs.filter(l => l.category === 'Secondary Work');
  const totalPrimary = primary.reduce((a,b) => a + b.durasi, 0);
  const totalSecondary = secondary.reduce((a,b) => a + b.durasi, 0);
  const dumpCount = primary.filter(l => l.item.toLowerCase().includes("dump")).length;
  const avgCycleTime = dumpCount > 0 ? totalPrimary / dumpCount : 0;
  const efficiency = totalPrimary / (totalPrimary + totalSecondary);
  const avgFill = logs.reduce((a,b)=>a+b.fillFactor,0) / logs.length;
  const swellFactor = parseFloat(document.getElementById("jenisMaterial").value) || 1;
  const produksi = (bucket * avgFill * 3600 * efficiency * swellFactor) / (avgCycleTime || 1);

  const digToLoad = primary.filter(l => l.item === "Dig to Load");
  const swingLoaded = primary.filter(l => l.item === "Swing Loaded");
  const swingEmpty = primary.filter(l => l.item === "Swing Empty");
  const dump = primary.filter(l => l.item === "Dump");

  const avg = arr => arr.length > 0 ? arr.reduce((a,b)=>a+b.durasi,0)/arr.length : 0;
  const suggestions = [];
  if (efficiency < 0.85) suggestions.push("‚ö†Ô∏è Primary work < 85%. Tingkatkan efisiensi penggalian, kurangi secondary time.");
  if (avg(digToLoad) > 14) suggestions.push("‚ö†Ô∏è Dig to Load > 12 detik. Optimalkan kinerja digging, sesuaikan sudut bucket dan sudut arm saat penggalian.");
  if (avg(swingLoaded) > 6 || avg(swingEmpty) > 6) suggestions.push("‚ö†Ô∏è Swing > 6 detik. Perkecil sudut swing.");
  if (avg(dump) > 6) suggestions.push("‚ö†Ô∏è Dump > 6 detik. Perbaiki posisi dump truck atau ketinggian bench.");

  document.getElementById("output").innerHTML = `
    <p><strong>Type Alat:</strong> ${typeAlat}</p>
    <p><strong>Kapasitas Bucket:</strong> ${kapasitas} m¬≥</p>
    <p><strong>Metode Loading:</strong> ${metode}</p>    
    <p><strong>Jenis Material:</strong> ${document.getElementById("jenisMaterial").selectedOptions[0].text}</p>
    <p><strong>Swell Factor:</strong> ${swellFactor}</p>
    <p><strong>Jumlah Truck:</strong> ${truckCount}</p>
    <hr>
    <p><strong>Total Duration:</strong> ${(totalPrimary + totalSecondary).toFixed(2)} s</p>
    <p><strong>Average Cycle Time/Pass:</strong> ${avgCycleTime.toFixed(2)} s</p>
    <p><strong>Primary Times:</strong> ${totalPrimary.toFixed(2)} s</p>
    <p><strong>Average Primary Times:</strong> ${(totalPrimary / (primary.length || 1)).toFixed(2)} s</p>
    <p><strong>Secondary Times:</strong> ${totalSecondary.toFixed(2)} s</p>
    <p><strong>Average Secondary Times:</strong> ${(totalSecondary / (secondary.length || 1)).toFixed(2)} s</p>
    <p><strong>Work Efficiency:</strong> ${(efficiency * 100).toFixed(2)}%</p>
    <p><strong>Average Bucket Fill Factor:</strong> ${avgFill.toFixed(2)}</p>
    <p><strong>Total Bucket Pass (Dump Count):</strong> ${dumpCount}</p>
    <p><strong>Productivity:</strong> ${produksi.toFixed(2)} m¬≥/jam</p>
  `;

  document.getElementById("btnExportPDF").disabled = false;
  document.getElementById("btnExportExcel").disabled = false;
  document.getElementById("btnExportSheets").disabled = false;
  document.getElementById("resume").innerHTML = `
    <h3>Resume Pengoperasian:</h3>
    <ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul>
    <h3>Summary Langkah:</h3>
    <table>
      <thead>
        <tr><th>Category</th><th>Item</th><th>Durasi (s)</th><th>Bucket Fill Factor</th></tr>
      </thead>
      <tbody>
        ${logs.map(l => `<tr><td>${l.category}</td><td>${l.item}</td><td>${l.durasi.toFixed(2)}</td><td>${l.fillFactor}</td></tr>`).join('')}
      </tbody>
    </table>
  `;

  // Create pie chart
  const pieChartCanvas = document.getElementById("pieChart");
  window.pieChart = new Chart(pieChartCanvas, {
    type: 'pie',
    data: {
      labels: ["Primary Work", "Secondary Work"],
      datasets: [{
        data: [totalPrimary, totalSecondary],
        backgroundColor: ["#007bff", "#ffc107"]
      }]
    }
  });
  pieChartCanvas.chart = window.pieChart;

  // Create bar chart
  const primaryItems = [...new Set(primary.map(p => p.item))];
  const avgDurasi = primaryItems.map(item => {
    const steps = primary.filter(p => p.item === item);
    return steps.reduce((a,b)=>a+b.durasi,0)/steps.length;
  });

  const barChartCanvas = document.getElementById("barChart");
  window.barChart = new Chart(barChartCanvas, {
    type: 'bar',
    data: {
      labels: primaryItems,
      datasets: [{
        label: "Rata-rata Durasi (detik)",
        data: avgDurasi,
        backgroundColor: "#28a745"
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  barChartCanvas.chart = window.barChart;
}

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  await new Promise(resolve => setTimeout(resolve, 500));
  const pdf = new jsPDF('p', 'pt', 'a4');
  const margin = 50;
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  let y = margin;

  pdf.setFontSize(16);
  pdf.setFont("helvetica", "bold");
  pdf.text("Laporan Produktivitas Excavator", pageWidth / 2, y, { align: "center" });
  y += 24;

  const output = document.getElementById("output").innerText.trim().split("\n");
  pdf.setFontSize(11);
  pdf.setFont("helvetica", "normal");
  output.forEach(line => {
    pdf.text(line, margin, y);
    y += 14;
  });

  y += 10;

  const pieCanvas = document.getElementById("pieChart");
  const barCanvas = document.getElementById("barChart");

  const chartContainer = document.createElement('div');
  chartContainer.style.position = "fixed";
  chartContainer.style.top = "-9999px";
  chartContainer.style.left = "-9999px";
  chartContainer.style.width = "800px";
  chartContainer.style.padding = "20px";
  chartContainer.style.background = "white";
  chartContainer.style.display = "flex";
  chartContainer.style.flexWrap = "wrap";
  chartContainer.style.justifyContent = "space-between";
  chartContainer.style.gap = "20px";
  chartContainer.style.zIndex = "-1";

  const pieImgEl = document.createElement("img");
  pieImgEl.src = pieCanvas.toDataURL("image/png");
  pieImgEl.style.width = "48%";

  const barImgEl = document.createElement("img");
  barImgEl.src = barCanvas.toDataURL("image/png");
  barImgEl.style.width = "48%";

  chartContainer.appendChild(pieImgEl);
  chartContainer.appendChild(barImgEl);
  document.body.appendChild(chartContainer);

  await new Promise(resolve => setTimeout(resolve, 1500));

  const canvasChart = await html2canvas(chartContainer, {
    scale: 2,
    scrollY: 0,
    windowWidth: chartContainer.scrollWidth,
    useCORS: true
  });

  const chartImg = canvasChart.toDataURL("image/png");
  const chartImgHeight = (canvasChart.height * (pageWidth - 2 * margin)) / canvasChart.width;

  if (y + chartImgHeight > pageHeight - margin) {
    pdf.addPage();
    y = margin;
  }

  pdf.addImage(chartImg, "PNG", margin, y, pageWidth - 2 * margin, chartImgHeight);
  y += chartImgHeight + 20;

  chartContainer.remove();

  // Add suggestions
  const resumeHTML = document.getElementById("resume").innerHTML;
  const parser = new DOMParser();
  const doc = parser.parseFromString(resumeHTML, "text/html");
  const lis = doc.querySelectorAll("ul li");

  if (lis.length > 0) {
    if (y + 20 > pageHeight - margin) {
      pdf.addPage();
      y = margin;
    }

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(12);
    pdf.text("Saran:", margin, y);
    y += 18;

    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(10);

    lis.forEach(li => {
      let bulletText = li.textContent.trim();
      bulletText = bulletText.replace(/[^a-zA-Z0-9\s.,%<>=:/()-]/g, "");

      const safeWidth = pageWidth - 2 * margin - 10;
      const wrapped = pdf.splitTextToSize("‚Ä¢ " + bulletText, safeWidth);

      wrapped.forEach(line => {
        if (y > pageHeight - margin - 12) {
          pdf.addPage();
          y = margin;
        }
        pdf.text(line, margin + 10, y);
        y += 12;
      });
    });
  }

  // Add table
  const table = document.querySelector("#resume table");
  if (table) {
    pdf.addPage();
    pdf.autoTable({
      startY: margin,
      html: table,
      styles: { fontSize: 10 },
      headStyles: { fillColor: [0, 123, 255] }
    });
  }

  pdf.save("TMSPro_Report.pdf");
}

function exportExcel() {
  const table = document.querySelector("#resume table");
  if (!table) return alert("Tidak ada data untuk diekspor.");

  const output = document.getElementById("output").innerText.trim().split("\n");

  // Ambil data ringkasan
  const ringkasan = output.map(line => {
    const idx = line.indexOf(":");
    if (idx === -1) return [line.trim(), ""];
    const key = line.substring(0, idx).trim();
    const value = line.substring(idx + 1).trim();
    return [key, value];
  });

  // Ambil data langkah operasi
  const rows = Array.from(table.rows).map((row, i) =>
    Array.from(row.cells).map((cell, j) => {
      const text = cell.innerText.trim().replace(",", ".");
      return i === 0 || isNaN(text) ? cell.innerText : parseFloat(text);
    })
  );

  // Gabungkan semua data
  const allData = [
    ["RINGKASAN PRODUKTIVITAS", ""],
    ...ringkasan,
    [],
    ["DETAIL LANGKAH OPERASI"],
    ...rows
  ];

  const ws = XLSX.utils.aoa_to_sheet(allData);
  ws["!merges"] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Laporan");
  XLSX.writeFile(wb, "TMSPro_Report.xlsx");
}

function exportToGoogleSheets() {
  if (logs.length === 0) {
    alert("Tidak ada data untuk diekspor!");
    return;
  }

  const data = {
    typeAlat: document.getElementById("typeAlat").value || "N/A",
    kapasitasBucket: document.getElementById("kapasitasBucket").value || "N/A",
    metodeLoading: document.getElementById("metodeLoading").value || "N/A",
    truckCount: truckCount.toString(),
    logs: JSON.stringify(logs)
  };

  const encodedData = Object.entries(data).map(
    ([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`
  ).join("&");
  
  const proxyUrl = "https://insoper.github.io/TMS-Pro-Spreadsheet/proxy.html";
  const proxyWindow = window.open(
    `${proxyUrl}?${encodedData}`,
    "_blank",
    "width=600,height=500"
  );
  
  const handleMessage = (event) => {
    if (typeof event.data !== 'object') return;
    
    if (event.data.success) {
      alert(event.data.message || "‚úÖ Data berhasil disimpan!");
      console.log("Detail:", event.data.details);
    } else {
      alert(`‚ùå ${event.data.error || "Gagal menyimpan data"}`);
      console.error("Error:", event.data);
    }
  };
  
  window.addEventListener("message", handleMessage);
  setTimeout(() => {
    window.removeEventListener("message", handleMessage);
  }, 10000);
}
</script>

<!-- External scripts -->
<script src="chart.js"></script>
<script src="html2canvas.min.js"></script>
<script src="jspdf.umd.min.js"></script>
<script src="jspdf.plugin.autotable.min.js"></script>
<script src="xlsx.full.min.js"></script>

</body>
</html>
